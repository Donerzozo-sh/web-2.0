<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="web-title">灵感矩阵 | 设计作品集</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 统一使用 Helvetica Now Display 字体，并提供系统回退 */
        body {
            font-family: 'Helvetica Now Display', 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            /* 隐藏滚动条，打造应用感 */
            overflow: hidden;
            /* 移除顶部填充，实现全屏感 */
            padding-top: 0; 
            background-color: #000;
            min-height: 100vh;
        }

        .grid-item {
            /* 关键：为 transform, opacity 和 filter 添加过渡效果，使其平滑
              使用 cubic-bezier 曲线使动画感觉更自然 
            */
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* 提升性能：告诉浏览器这个元素的 transform 属性将会改变 */
            will-change: transform, opacity, filter;
            
            /* 设置一个基础的不透明度 */
            opacity: 0.7;
        }

        #grid-container {
            /* 设置一个大于视窗的固定尺寸 */
            width: 140vw;
            height: 140vh;
        }

        /* 自定义滚动条样式，使其不那么突兀 */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        /* 隐藏原生颜色选择器的输入框 */
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 6px; /* 与 Tailwind rounded-lg 匹配 */
        }
    </style>
    <!-- 引入 Firebase SDK (需要 Firestore 和 Auth) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase & State Variables ---
        let db, auth; 
        let isLocalMode = false; // 本地模式标志

        // --- DOM 元素声明 (初始化为 null，在 setupDOMAndListeners 中赋值) ---
        let gridContainer, modal, videoPlayer, closeModal, mainTitleEl, subTextEl;
        let editContainer, contentDisplay, editTitleEl, editSubtitleEl, topContentArea;
        let editWebTitleEl, editTitleSizeEl, editTitleWeightEl, editTitleColorPickerEl, editTitleSpacingEl;
        let editSubtitleSizeEl, editSubtitleWeightEl, editSubtitleColorPickerEl, editSubtitleSpacingEl;
        let adminToggleBtn, itemEditModal, itemEditIdEl, editImageUrlEl, editVideoUrlEl;
        let authModal, authUsernameEl, authPasswordEl, authErrorMessageEl;


        // --- 配置/状态变量 ---
        const NUM_COLS = 14; 
        const NUM_ROWS = 10; 
        const TOTAL_ITEMS = NUM_COLS * NUM_ROWS;
        const MAX_SCALE = 3.0; 
        const MIN_SCALE = 0.175; 
        const EFFECT_RADIUS = 150; 
        const PLACEHOLDER_VID = "https://www.w3schools.com/html/mov_bbb.mp4";

        const GRID_COLORS = [
            '#EF4444', 
            '#F97316', 
            '#F59E0B', 
            '#10B981', 
            '#3B82F6', 
            '#6366F1', 
            '#8B5CF6', 
            '#EC4899', 
            '#FBBF24', 
            '#A78BFA', 
            '#4ADE80', 
            '#FB7185', 
            '#D946EF', 
            '#06B6D4', 
        ];

        function getColumnIndex(index) {
            return index % NUM_COLS;
        }

        function getColorForColumn(colIndex) {
            return GRID_COLORS[colIndex % GRID_COLORS.length];
        }


        const DEFAULT_CONTENT = {
            title: "3D&Motion Creative&Production",
            subtitle: "Powerd by REDesign",
            webTitle: "灵感矩阵 | 设计作品集",
            titleStyle: {
                size: 'text-8xl', 
                weight: 'font-extrabold',
                color: '#FFFFFF', 
                spacing: 'tracking-normal'
            },
            subtitleStyle: {
                size: 'text-2xl', 
                weight: 'font-normal',
                color: '#9CA3AF', 
                spacing: 'tracking-normal'
            }
        };

        let items = []; 
        let itemData = {}; 
        let mousePos = { x: 0, y: 0 }; 
        let isMouseActive = false; 
        let animationFrameId = null; 
        let isPanning = false;
        let panOffset = { x: 0, y: 0 };
        let lastPanPos = { x: 0, y: 0 };
        let isAnimatingPan = false;
        let targetPanOffset = { x: 0, y: 0 };
        let itemToOpen = null;
        let parallaxOffset = { x: 0, y: 0 };
        const PARALLAX_INTENSITY = 0.4; 
        let isAdminMode = false;
        let editingItemId = null; 

        const getTopBannerDocPath = (appIdentifier) => `/artifacts/${appIdentifier}/public/data/homepage_content/top_banner`;
        const getGridCollectionPath = (appIdentifier) => `/artifacts/${appIdentifier}/public/data/grid_items`;


        // --- 样式辅助函数 (保持不变) ---

        function applyTextStyles(element, styleData, isTitle) {
            if (!element) return; // 增加空值检查

            const prefixesToClear = [
                'text-', 'font-', 'tracking-' 
            ];
            
            element.className = element.className.split(' ').filter(c => 
                !prefixesToClear.some(prefix => c.startsWith(prefix))
            ).join(' ');

            if (styleData.size) element.classList.add(styleData.size);
            if (styleData.weight) element.classList.add(styleData.weight);
            if (styleData.spacing) element.classList.add(styleData.spacing);
            
            element.style.color = styleData.color || (isTitle ? '#FFFFFF' : '#9CA3AF');

            if (isTitle) {
                element.classList.add('mb-4', 'transition-colors', 'duration-500', 'hover:text-yellow-400', 'cursor-text');
                element.classList.add('md:text-8xl'); 
            } else {
                element.classList.add('transition-colors', 'duration-500', 'hover:text-gray-200', 'cursor-text');
                element.classList.add('md:text-2xl'); 
            }
        }

        // --- Admin/Auth 逻辑 (已修改) ---

        window.setAdminMode = (mode) => {
            isAdminMode = mode;
            if (!adminToggleBtn || !topContentArea) return; // 增加空值检查
            
            if (mode) {
                adminToggleBtn.textContent = 'Admin Mode (ON)';
                adminToggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                adminToggleBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                isAnimatingPan = false;
                itemToOpen = null;
                topContentArea.classList.add('border-b-4', 'border-red-600');
                window.closeAuthModal(); 
                console.log("Admin Mode activated.");
            } else {
                adminToggleBtn.textContent = 'Admin Mode (OFF)';
                adminToggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                adminToggleBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                topContentArea.classList.remove('border-b-4', 'border-red-600');
                console.log("Admin Mode deactivated.");
            }
        };

        window.handleAdminToggle = () => {
            if (!adminToggleBtn) return; // 增加空值检查
            if (isAdminMode) {
                window.setAdminMode(false);
            } else {
                window.openAuthModal();
            }
        };

        window.openAuthModal = () => {
            if (!authModal || !authErrorMessageEl || !authPasswordEl) return; // 增加空值检查

            authErrorMessageEl.classList.add('hidden'); 
            authPasswordEl.value = ''; 
            authModal.classList.remove('hidden');
        };

        window.closeAuthModal = () => {
            if (!authModal) return; // 增加空值检查
            authModal.classList.add('hidden');
        };

        window.handleAdminLogin = () => {
            if (!authUsernameEl || !authPasswordEl || !authErrorMessageEl) return; // 增加空值检查

            const username = authUsernameEl.value.trim();
            const password = authPasswordEl.value.trim();
            
            const correctUsername = 'admin';
            const correctPassword = '1234'; 

            if (username === correctUsername && password === correctPassword) {
                window.setAdminMode(true);
            } else {
                authErrorMessageEl.classList.remove('hidden');
                authPasswordEl.value = ''; 
            }
        };
        
        /**
         * 切换编辑模式 (顶部文本) - 仅当 Admin Mode 启用时才能编辑
         */
        window.toggleEditMode = (enable) => {
            if (!isAdminMode || !editContainer || !contentDisplay || !mainTitleEl || !subTextEl || !editWebTitleEl) {
                return; // 增加大量空值检查
            }
            
            if (enable) {
                const titleStyle = mainTitleEl.dataset.style ? JSON.parse(mainTitleEl.dataset.style) : DEFAULT_CONTENT.titleStyle;
                const subtitleStyle = subTextEl.dataset.style ? JSON.parse(subTextEl.dataset.style) : DEFAULT_CONTENT.subtitleStyle;

                // 填充网站名称
                document.getElementById('web-title').textContent = DEFAULT_CONTENT.webTitle; 
                editWebTitleEl.value = document.getElementById('web-title').textContent;

                // 填充文本内容
                editTitleEl.value = mainTitleEl.textContent;
                editSubtitleEl.value = subTextEl.textContent;

                // 填充主标题样式
                editTitleSizeEl.value = titleStyle.size;
                editTitleWeightEl.value = titleStyle.weight;
                editTitleColorPickerEl.value = titleStyle.color;
                editTitleSpacingEl.value = titleStyle.spacing;

                // 填充副标题样式
                editSubtitleSizeEl.value = subtitleStyle.size;
                editSubtitleWeightEl.value = subtitleStyle.weight;
                editSubtitleColorPickerEl.value = subtitleStyle.color;
                editSubtitleSpacingEl.value = subtitleStyle.spacing;

                contentDisplay.classList.add('hidden');
                editContainer.classList.remove('hidden');
            } else {
                contentDisplay.classList.remove('hidden');
                editContainer.classList.add('hidden');
            }
        };

        /**
         * 保存内容到 Firestore (顶部文本)
         */
        window.saveContent = async () => {
            if (!editWebTitleEl || !editTitleEl || !editSubtitleEl || !editTitleSizeEl) {
                return console.error("Missing edit elements. Cannot save."); // 增加空值检查
            }

            const newWebTitle = editWebTitleEl.value.trim(); 
            const newTitle = editTitleEl.value.trim();
            const newSubtitle = editSubtitleEl.value.trim();

            if (isLocalMode || !db || !appId) return console.error("Firestore is not initialized. Cannot save in local mode.");
            if (!isAdminMode) return console.error("Permission denied. Admin mode required.");

            const docRef = doc(db, getTopBannerDocPath(appId));
            
            const newTitleStyle = {
                size: editTitleSizeEl.value,
                weight: editTitleWeightEl.value,
                color: editTitleColorPickerEl.value,
                spacing: editTitleSpacingEl.value,
            };

            const newSubtitleStyle = {
                size: editSubtitleSizeEl.value,
                weight: editSubtitleWeightEl.value,
                color: editSubtitleColorPickerEl.value,
                spacing: editSubtitleSpacingEl.value,
            };

            try {
                await setDoc(docRef, {
                    webTitle: newWebTitle || DEFAULT_CONTENT.webTitle, 
                    title: newTitle || DEFAULT_CONTENT.title,
                    subtitle: newSubtitle || DEFAULT_CONTENT.subtitle,
                    titleStyle: newTitleStyle,
                    subtitleStyle: newSubtitleStyle,
                    timestamp: new Date()
                });
                console.log("Content saved successfully.");
                window.toggleEditMode(false);
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        };

        /**
         * **本地回退逻辑**：如果无法连接 Firebase，则使用默认数据并立即渲染。
         */
        window.runLocalFallback = () => {
            if (!mainTitleEl || !subTextEl || !gridContainer) {
                 console.error("Critical DOM elements (mainTitleEl/subTextEl/gridContainer) not found for fallback.");
                 return;
            }
            isLocalMode = true;
            console.warn("Firebase configuration missing or initialization failed. Running in Local Mode with default data.");
            
            // 1. 立即应用默认内容
            document.title = DEFAULT_CONTENT.webTitle; 
            mainTitleEl.textContent = DEFAULT_CONTENT.title;
            subTextEl.textContent = DEFAULT_CONTENT.subtitle;
            applyTextStyles(mainTitleEl, DEFAULT_CONTENT.titleStyle, true);
            applyTextStyles(subTextEl, DEFAULT_CONTENT.subtitleStyle, false);
            
            // 2. 初始化网格数据并渲染
            initializeDefaultGridData(); 
            createGrid(); 
        };


        /**
         * 监听 Firestore 上的内容变化
         * @param {object} firestore 传入的 db 实例
         * @param {string} appIdentifier 传入的 appId
         */
        window.setupContentListener = (firestore, appIdentifier) => {
            if (!mainTitleEl || !subTextEl) return; // 增加空值检查
            
            const docRef = doc(firestore, getTopBannerDocPath(appIdentifier)); 

            onSnapshot(docRef, (docSnap) => {
                let data = {};
                if (docSnap.exists()) {
                    data = docSnap.data();
                }

                const currentWebTitle = data.webTitle || DEFAULT_CONTENT.webTitle; 
                const currentTitle = data.title || DEFAULT_CONTENT.title;
                const currentSubtitle = data.subtitle || DEFAULT_CONTENT.subtitle;
                const currentTitleStyle = data.titleStyle || DEFAULT_CONTENT.titleStyle;
                const currentSubtitleStyle = data.subtitleStyle || DEFAULT_CONTENT.subtitleStyle;

                document.title = currentWebTitle; 
                mainTitleEl.textContent = currentTitle;
                subTextEl.textContent = currentSubtitle;

                applyTextStyles(mainTitleEl, currentTitleStyle, true);
                applyTextStyles(subTextEl, currentSubtitleStyle, false);

                mainTitleEl.dataset.style = JSON.stringify(currentTitleStyle);
                subTextEl.dataset.style = JSON.stringify(currentSubtitleStyle);

            }, (error) => {
                console.error("Error listening to content:", error);
            });
        };

        /**
         * 监听 Firestore 上的网格项目变化
         * @param {object} firestore 传入的 db 实例
         * @param {string} appIdentifier 传入的 appId
         */
        window.setupGridListener = (firestore, appIdentifier) => {
            if (!gridContainer) return; // 增加空值检查
            
            const colRef = collection(firestore, getGridCollectionPath(appIdentifier)); 

            onSnapshot(colRef, (snapshot) => {
                let initialLoad = Object.keys(itemData).length === 0;
                
                const newItemsFromFirestore = {};
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const itemId = change.doc.id;
                    const i = parseInt(itemId.split('_')[1]);
                    const colIndex = getColumnIndex(i);
                    const defaultColor = getColorForColumn(colIndex);

                    newItemsFromFirestore[itemId] = {
                        img: data.img || null, 
                        vid: data.vid || PLACEHOLDER_VID,
                        bgColor: data.bgColor || defaultColor 
                    };
                });
                itemData = newItemsFromFirestore; // Update global itemData

                if (initialLoad) {
                    let needsDefaultInit = false;
                    for (let i = 0; i < TOTAL_ITEMS; i++) {
                        const itemId = `item_${i}`;
                        if (!itemData[itemId]) {
                            needsDefaultInit = true;
                            break;
                        }
                    }

                    if(needsDefaultInit) {
                        initializeDefaultGridData();
                    }
                    createGrid();
                } else {
                    updateGridDOM();
                }
            }, async (error) => {
                console.error("Error listening to grid items:", error);
                if (Object.keys(itemData).length === 0) {
                    await initializeDefaultGridData();
                    createGrid();
                }
            });
        };
        
        /**
         * 初始化默认网格数据 (本地模式下不写入 DB)
         */
        async function initializeDefaultGridData() {
            if (!gridContainer) return; // 增加空值检查

            // 如果是本地模式，只填充 itemData 数组，不进行 DB 操作
            if (isLocalMode) {
                for (let i = 0; i < TOTAL_ITEMS; i++) {
                    const itemId = `item_${i}`;
                    const colIndex = getColumnIndex(i);
                    itemData[itemId] = {
                        img: null,
                        vid: PLACEHOLDER_VID,
                        bgColor: getColorForColumn(colIndex)
                    };
                }
                return; 
            }

            // 远程模式 (Firestore 存在)
            if (!db || !appId) return console.error("Firestore DB/App ID not ready for default initialization.");

            const colRef = collection(db, getGridCollectionPath(appId));
            const snapshot = await getDocs(colRef);

            if (snapshot.empty) {
                console.log("No existing grid data. Initializing default items.");
                for (let i = 0; i < TOTAL_ITEMS; i++) {
                    const itemId = `item_${i}`;
                    const colIndex = getColumnIndex(i);
                    const defaultColor = getColorForColumn(colIndex);

                    itemData[itemId] = {
                        img: null, 
                        vid: PLACEHOLDER_VID,
                        bgColor: defaultColor
                    };
                    // 仅写入一小部分数据到 Firestore，其余由客户端处理
                    if (i < 5) { 
                        await setDoc(doc(db, getGridCollectionPath(appId), itemId), itemData[itemId]);
                    }
                }
            } else {
                 snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const i = parseInt(doc.id.split('_')[1]);
                    const colIndex = getColumnIndex(i);
                    const defaultColor = getColorForColumn(colIndex);

                    itemData[doc.id] = {
                        img: data.img || null,
                        vid: data.vid || PLACEHOLDER_VID,
                        bgColor: data.bgColor || defaultColor
                    };
                });
            }
        }
        
        function createGrid() {
            if (items.length > 0 || !gridContainer) return; // 增加空值检查
            
            gridContainer.innerHTML = ''; 
            gridContainer.style.gridTemplateColumns = `repeat(${NUM_COLS}, 1fr)`;

            for (let i = 0; i < TOTAL_ITEMS; i++) {
                const itemId = `item_${i}`;
                const data = itemData[itemId]; 

                const item = document.createElement('div');
                item.className = 'grid-item aspect-square bg-cover bg-center cursor-pointer';
                
                if (data && data.img && data.img.trim()) {
                    item.style.backgroundImage = `url(${data.img})`;
                    item.style.backgroundColor = 'transparent';
                } else if (data && data.bgColor) {
                    item.style.backgroundImage = 'none';
                    item.style.backgroundColor = data.bgColor;
                } else {
                    const colIndex = getColumnIndex(i);
                    item.style.backgroundImage = 'none';
                    item.style.backgroundColor = getColorForColumn(colIndex);
                }

                item.style.transform = `scale(${MIN_SCALE})`; 
                item.style.opacity = '0.7'; 

                item.dataset.videoId = itemId;
                
                gridContainer.appendChild(item);
                
                item.twinklePhase = Math.random() * 2 * Math.PI;
                item.twinkleSpeed = 0.5 + Math.random() * 0.5;

                items.push({ 
                    el: item, 
                    center: { x: 0, y: 0 },
                    twinklePhase: item.twinklePhase,
                    twinkleSpeed: item.twinkleSpeed
                });
            }
            
            cacheItemPositions();
        }

        function updateGridDOM() {
            if (items.length === 0 || !gridContainer) return; // 增加空值检查

            for(let i = 0; i < items.length; i++) {
                const itemId = `item_${i}`;
                const data = itemData[itemId];
                
                if (data) { 
                    if (data.img && data.img.trim()) {
                        items[i].el.style.backgroundImage = `url(${data.img})`;
                        items[i].el.style.backgroundColor = 'transparent';
                    } else {
                        items[i].el.style.backgroundImage = 'none';
                        items[i].el.style.backgroundColor = data.bgColor;
                    }
                } else {
                    const itemIndex = parseInt(itemId.split('_')[1]);
                    const colIndex = getColumnIndex(itemIndex);
                    items[i].el.style.backgroundImage = 'none';
                    items[i].el.style.backgroundColor = getColorForColumn(colIndex);
                }
            }
        }

        window.openItemEditPanel = (itemElement) => {
            if (!itemEditModal || !itemEditIdEl || !editImageUrlEl || !editVideoUrlEl) return; // 增加空值检查
            if (!isAdminMode) return console.error("Permission denied. Admin mode required.");
            if (isLocalMode) return console.error("Cannot edit in local mode. Requires Firebase connection.");

            editingItemId = itemElement.dataset.videoId;
            let data = itemData[editingItemId]; 
            
            if (!data) {
                const parts = editingItemId.split('_');
                if (parts.length < 2) return console.error("Invalid item ID format:", editingItemId);
                
                const itemIndex = parseInt(parts[1]);
                const colIndex = getColumnIndex(itemIndex);
                
                data = {
                    img: null, 
                    vid: PLACEHOLDER_VID,
                    bgColor: getColorForColumn(colIndex)
                };
            }

            itemEditIdEl.textContent = `(ID: ${editingItemId})`;
            editImageUrlEl.value = data.img || ''; 
            editVideoUrlEl.value = data.vid;
            
            itemEditModal.classList.remove('hidden');
            isAnimatingPan = false;
            itemToOpen = null;
        };
        
        window.closeItemEditPanel = () => {
            if (!itemEditModal) return; // 增加空值检查
            itemEditModal.classList.add('hidden');
            editingItemId = null;
            isMouseActive = true;
            startAnimationLoop();
        };

        window.saveItemChanges = async () => {
            if (!editImageUrlEl || !editVideoUrlEl) return; // 增加空值检查

            const newImg = editImageUrlEl.value.trim();
            const newVid = editVideoUrlEl.value.trim();

            if (isLocalMode || !db || !appId || !editingItemId) return console.error("Invalid state for saving. Cannot save in local mode.");
            if (!isAdminMode) return console.error("Permission denied. Admin mode required.");

            const itemIndex = parseInt(editingItemId.split('_')[1]);
            const colIndex = getColumnIndex(itemIndex);
            const defaultColor = getColorForColumn(colIndex);

            const dataToSave = { 
                vid: newVid,
                bgColor: itemData[editingItemId]?.bgColor || defaultColor, 
            };
            
            if (newImg) {
                dataToSave.img = newImg; 
            } else {
                dataToSave.img = null; 
            }

            const docRef = doc(db, getGridCollectionPath(appId), editingItemId);

            try {
                await setDoc(docRef, dataToSave, { merge: true }); 
                console.log(`Item ${editingItemId} saved successfully.`);
                window.closeItemEditPanel();
            } catch (e) {
                console.error("Error saving grid item: ", e);
            }
        };

        /**
         * 1. 获取所有 DOM 元素的引用
         * 2. 绑定所有事件监听器
         */
        function setupDOMAndListeners() {
            // --- 1. DOM 元素获取 (现在是安全的，在 window.onload 之后执行) ---
            gridContainer = document.getElementById('grid-container');
            modal = document.getElementById('video-modal');
            videoPlayer = document.getElementById('video-player');
            closeModal = document.getElementById('close-modal');
            mainTitleEl = document.getElementById('main-title');
            subTextEl = document.getElementById('sub-text');
            editContainer = document.getElementById('edit-mode-container');
            contentDisplay = document.getElementById('content-display');
            editTitleEl = document.getElementById('edit-title');
            editSubtitleEl = document.getElementById('edit-subtitle');
            topContentArea = document.getElementById('top-content-area');

            // Admin Text Edit Elements
            editWebTitleEl = document.getElementById('edit-web-title'); 
            editTitleSizeEl = document.getElementById('edit-title-size');
            editTitleWeightEl = document.getElementById('edit-title-weight');
            editTitleColorPickerEl = document.getElementById('edit-title-color-picker');
            editTitleSpacingEl = document.getElementById('edit-title-spacing');
            editSubtitleSizeEl = document.getElementById('edit-subtitle-size');
            editSubtitleWeightEl = document.getElementById('edit-subtitle-weight');
            editSubtitleColorPickerEl = document.getElementById('edit-subtitle-color-picker');
            editSubtitleSpacingEl = document.getElementById('edit-subtitle-spacing');


            // Admin UI elements
            adminToggleBtn = document.getElementById('admin-toggle-btn');
            itemEditModal = document.getElementById('item-edit-modal');
            itemEditIdEl = document.getElementById('item-edit-id');
            editImageUrlEl = document.getElementById('edit-image-url');
            editVideoUrlEl = document.getElementById('edit-video-url');
            // Auth UI elements
            authModal = document.getElementById('auth-modal');
            authUsernameEl = document.getElementById('auth-username');
            authPasswordEl = document.getElementById('auth-password');
            authErrorMessageEl = document.getElementById('auth-error-message');
            
            // --- CRITICAL SAFETY CHECK ---
            // 确保最主要的元素已被获取，否则停止设置监听器
            if (!gridContainer || !closeModal || !modal) {
                console.error("Critical DOM elements not found. Stopping setupDOMAndListeners.");
                return;
            }

            // --- 2. 绑定事件监听器 (现在是安全的) ---

            window.addEventListener('mousemove', (e) => {
                mousePos.x = e.clientX;
                mousePos.y = e.clientY;

                if (isPanning) {
                    e.preventDefault();
                    const dx = e.clientX - lastPanPos.x;
                    const dy = e.clientY - lastPanPos.y;
                    panOffset.x += dx;
                    panOffset.y += dy;
                    applyGridTransform();
                    lastPanPos = { x: e.clientX, y: e.clientY };
                } 
                else if (!isMouseActive) {
                    isMouseActive = true;
                    startAnimationLoop();
                }
            });

            window.addEventListener('mouseenter', () => {
                if (!isMouseActive) {
                    isMouseActive = true;
                    startAnimationLoop();
                }
            });

            window.addEventListener('mouseleave', () => {
                isMouseActive = false;
                resetGrid(); 
            });

            gridContainer.addEventListener('click', (e) => {
                if (isPanning || isAnimatingPan) return;

                const itemElement = e.target.closest('.grid-item');
                if (itemElement) {
                    const itemId = itemElement.dataset.videoId;
                    const clickedItem = items.find(i => i.el === itemElement);
                    if (!clickedItem) return;
                    
                    // 如果是 Admin 模式，打开编辑面板
                    if (isAdminMode) {
                        window.openItemEditPanel(itemElement);
                        return; 
                    }

                    // 正常播放模式
                    isMouseActive = false; 
                    
                    const targetX = window.innerWidth / 2;
                    const targetY = window.innerHeight / 2;
                    
                    targetPanOffset = {
                        x: targetX - clickedItem.center.x,
                        y: targetY - clickedItem.center.y
                    };

                    isAnimatingPan = true;
                    itemToOpen = clickedItem;

                    startAnimationLoop();
                }
            });

            closeModal.addEventListener('click', closeVideoModalFunc);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeVideoModalFunc();
                }
            });

            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    cacheItemPositions();
                }, 100);
            });

            gridContainer.addEventListener('mousedown', (e) => {
                if (e.button === 1 && !isAdminMode) { 
                    e.preventDefault();
                    isPanning = true;
                    isMouseActive = false; 
                    isAnimatingPan = false; 
                    itemToOpen = null;      
                    
                    resetGrid(); 
                    lastPanPos = { x: e.clientX, y: e.clientY };
                    gridContainer.style.cursor = 'grabbing';
                    
                    startAnimationLoop();
                }
            });

            window.addEventListener('mouseup', (e) => {
                if (isPanning && e.button === 1) {
                    isPanning = false;
                    gridContainer.style.cursor = 'default';
                    
                    isMouseActive = true;
                    startAnimationLoop();
                }
            });

            window.addEventListener('contextmenu', (e) => {
                if (isPanning || e.button === 1) {
                    e.preventDefault();
                }
            });
        }


        /**
         * 修复权限错误：确保身份验证成功后才设置 Firestore 监听器。
         */
        window.setupApp = async () => {
            
            setupDOMAndListeners(); // <-- 必须在操作 DOM 之前运行

            // 检查 Firebase 配置是否有效
            const hasFirebaseConfig = Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey; 

            if (!hasFirebaseConfig) {
                window.runLocalFallback(); // 如果配置缺失，运行本地回退
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); // 赋值给全局变量 db
                auth = getAuth(app); // 赋值给全局变量 auth
                
                setLogLevel('error'); 

                // --- 1. 尝试执行身份验证 ---
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => { // 使用 auth
                        console.error("Custom token sign-in failed:", e);
                    });
                } else {
                    await signInAnonymously(auth).catch(e => { // 使用 auth
                        console.error("Anonymous sign-in failed:", e);
                    });
                }
                console.log("Firebase authentication attempt completed.");


                // --- 2. 监听器确保 Firestore 客户端准备就绪 ---
                const unsubscribe = onAuthStateChanged(auth, (user) => { // 使用 auth
                    if (user) {
                        console.log("User state confirmed. Setting up Firestore listeners.");
                        window.setupContentListener(db, appId);
                        window.setupGridListener(db, appId);
                        unsubscribe(); 
                    } else {
                        console.warn("User is not logged in. Waiting for sign-in state.");
                    }
                }, (error) => {
                     console.error("onAuthStateChanged error:", error);
                     window.runLocalFallback(); // 如果认证监听器失败，也回退
                });
                
            } catch (error) {
                // 捕获 Firebase 初始化错误
                console.error("Firebase Initialization/Sign-In Error, falling back:", error);
                window.runLocalFallback(); // 捕获初始化错误，运行本地回退
            }
        };

        // Call initialization on load
        window.addEventListener('load', window.setupApp);

        // --- 原有动画/交互函数 (保持) ---

        function cacheItemPositions() {
            if (!gridContainer) return; // 增加空值检查
            
            const oldTransform = gridContainer.style.transform;
            gridContainer.style.transform = ''; 

            for (const item of items) {
                const rect = item.el.getBoundingClientRect();
                item.center = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
            }

            gridContainer.style.transform = oldTransform;
        }

        function applyGridTransform() {
            if (!gridContainer) return; // 增加空值检查，修复第二个错误

            const finalX = panOffset.x + parallaxOffset.x;
            const finalY = panOffset.y + parallaxOffset.y;
            gridContainer.style.transform = `translate(${finalX}px, ${finalY}px)`;
        }

        function updateFisheyeEffect() {
            if (!gridContainer) { // 再次检查关键元素，防止动画循环中出现问题
                 animationFrameId = null;
                 return;
            }

            // --- 1. 处理点击平移动画 ---
            if (isAnimatingPan) {
                const easing = 0.08; 
                panOffset.x += (targetPanOffset.x - panOffset.x) * easing;
                panOffset.y += (targetPanOffset.y - panOffset.y) * easing;

                parallaxOffset.x = 0;
                parallaxOffset.y = 0;

                const dx = targetPanOffset.x - panOffset.x;
                const dy = targetPanOffset.y - panOffset.y;

                if (Math.abs(dx) < 0.5 && Math.abs(dy) < 0.5) {
                    isAnimatingPan = false;
                    panOffset.x = targetPanOffset.x; 
                    panOffset.y = targetPanOffset.y;
                    
                    if (itemToOpen) {
                        const videoSrc = itemData[itemToOpen.el.dataset.videoId]?.vid || PLACEHOLDER_VID;
                        openVideoModal(videoSrc);
                        itemToOpen = null;
                    }
                }
            }
            // --- 2. 处理鼠标视差 (仅当鼠标激活且未进行其他平移时) ---
            else if (isMouseActive && !isPanning) {
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const dx_parallax = mousePos.x - centerX;
                const dy_parallax = mousePos.y - centerY;
                
                parallaxOffset.x = -dx_parallax * PARALLAX_INTENSITY;
                parallaxOffset.y = -dy_parallax * PARALLAX_INTENSITY;
            }
            // --- 3. 鼠标移出或手动平移时 ---
            else {
                parallaxOffset.x = 0;
                parallaxOffset.y = 0;
            }

            // --- 4. 应用变换 ---
            applyGridTransform(); 

            if (isPanning || isAdminMode) {
                animationFrameId = requestAnimationFrame(updateFisheyeEffect);
                return;
            }

            // --- 5. 鱼眼效果计算 (跟随鼠标) ---
            const fisheyeCenterX = mousePos.x;
            const fisheyeCenterY = mousePos.y;

            for (const item of items) {
                const adjustedItemCenterX = item.center.x + panOffset.x + parallaxOffset.x; 
                const adjustedItemCenterY = item.center.y + panOffset.y + parallaxOffset.y; 

                const dx = fisheyeCenterX - adjustedItemCenterX;
                const dy = fisheyeCenterY - adjustedItemCenterY;
                const dist = Math.sqrt(dx * dx + dy * dy);

                let scale;
                let opacity;
                let zIndex = 1;
                let brightness = 1.0; 

                if (dist >= EFFECT_RADIUS) {
                    
                    opacity = 0.7;
                    
                    // --- 6. 强化闪烁效果 (Twinkling: 亮度 + 大小) ---
                    item.twinklePhase += (0.02 + Math.random() * 0.01) * item.twinkleSpeed;
                    const sineVal = (Math.sin(item.twinklePhase) + 1) / 2; // Range [0, 1]
                    
                    const minBrightness = 0.2; 
                    const maxBrightness = 1.4; 
                    const brightnessRange = maxBrightness - minBrightness; 
                    brightness = minBrightness + (brightnessRange * sineVal);
                    
                    const minTwinkleScale = MIN_SCALE * 0.70; 
                    const maxTwinkleScale = MIN_SCALE * 1.30; 
                    const scaleRange = maxTwinkleScale - minTwinkleScale;
                    
                    scale = minTwinkleScale + (scaleRange * sineVal); 
                    
                } else {
                    // 鱼眼效果区域
                    const proximity = 1 - (dist / EFFECT_RADIUS);
                    
                    const easedProximity = 1 - Math.pow(1 - proximity, 2); 
                    
                    scale = MIN_SCALE + (MAX_SCALE - MIN_SCALE) * easedProximity;
                    opacity = 0.7 + (1.0 - 0.7) * easedProximity;
                    
                    zIndex = 2 + Math.floor(proximity * 8); 
                    brightness = 1.0; 
                }

                item.el.style.transform = `translateZ(0) scale(${scale})`;
                item.el.style.opacity = opacity;
                item.el.style.zIndex = zIndex;
                item.el.style.filter = `brightness(${brightness})`;
            }
            
            if (isAnimatingPan || (isMouseActive && !isPanning)) {
                animationFrameId = requestAnimationFrame(updateFisheyeEffect);
            } else {
                animationFrameId = null; 
            }
        }

        function startAnimationLoop() {
            if (!gridContainer) return; // 增加空值检查
            if (!animationFrameId) {
                animationFrameId = requestAnimationFrame(updateFisheyeEffect);
            }
        }

        function resetGrid() {
            if (items.length === 0 || !gridContainer) return; // 增加空值检查

            for (const item of items) {
                item.el.style.transform = `scale(${MIN_SCALE})`;
                item.el.style.opacity = '0.7';
                item.el.style.zIndex = 1;
                item.el.style.filter = 'brightness(1.0)'; 
            }
        }

        function openVideoModal(videoSrc) {
            if (!modal || !videoPlayer) return; // 增加空值检查

            videoPlayer.src = videoSrc;
            modal.classList.remove('hidden');
            videoPlayer.play().catch(e => {
                if (e.name !== 'AbortError') {
                    console.error("视频播放失败:", e);
                }
            });
        }

        function closeVideoModalFunc() {
            if (!modal || !videoPlayer) return; // 增加空值检查

            modal.classList.add('hidden');
            videoPlayer.pause();
            videoPlayer.src = ''; 
            isMouseActive = true; 
            startAnimationLoop();
        }

    </script>
    <div id="app-container" class="relative min-h-screen w-full bg-black overflow-hidden">

        <!-- 顶部内容区域/编辑模式 -->
        <div id="top-content-area" class="fixed top-0 left-0 right-0 p-8 md:p-12 z-20 text-white pointer-events-none transition-all duration-300">
            <div id="content-display" class="flex flex-col">
                <h1 id="main-title" class="text-white text-4xl font-extrabold cursor-text transition-colors duration-500 hover:text-yellow-400 pointer-events-auto" onclick="toggleEditMode(true)">3D&Motion Creative&Production</h1>
                <p id="sub-text" class="text-gray-400 text-base font-normal cursor-text transition-colors duration-500 hover:text-gray-200 pointer-events-auto" onclick="toggleEditMode(true)">Powerd by REDesign</p>
            </div>

            <!-- 编辑模式 UI (Admin Only) -->
            <div id="edit-mode-container" class="hidden bg-gray-900/90 backdrop-blur-sm p-6 rounded-xl shadow-2xl pointer-events-auto">
                <h2 class="text-xl font-bold mb-4 text-red-400">顶部内容编辑 (Admin)</h2>
                
                <div class="space-y-4">
                    <!-- Web Title -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400">网站标题 (Title)</label>
                        <input id="edit-web-title" type="text" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2" value="灵感矩阵 | 设计作品集">
                    </div>
                    
                    <!-- Main Title Edit -->
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <label class="block text-lg font-medium text-white mb-2">主标题</label>
                        <input id="edit-title" type="text" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2" value="3D&Motion Creative&Production">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3 text-sm">
                            <select id="edit-title-size" class="rounded-md bg-gray-700 border-gray-600 text-white p-2">
                                <option value="text-8xl">特大号</option>
                                <option value="text-6xl">大号</option>
                                <option value="text-4xl">中号</option>
                            </select>
                            <select id="edit-title-weight" class="rounded-md bg-gray-700 border-gray-600 text-white p-2">
                                <option value="font-extrabold">极粗</option>
                                <option value="font-bold">粗体</option>
                                <option value="font-semibold">半粗</option>
                            </select>
                            <input id="edit-title-color-picker" type="color" class="h-10 w-full rounded-md bg-gray-700 border-gray-600 p-1 cursor-pointer" value="#FFFFFF">
                            <select id="edit-title-spacing" class="rounded-md bg-gray-700 border-gray-600 text-white p-2">
                                <option value="tracking-normal">默认间距</option>
                                <option value="tracking-wider">更宽</option>
                                <option value="tracking-tight">更紧</option>
                            </select>
                        </div>
                    </div>

                    <!-- Subtitle Edit -->
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <label class="block text-lg font-medium text-white mb-2">副标题</label>
                        <input id="edit-subtitle" type="text" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2" value="Powerd by REDesign">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3 text-sm">
                            <select id="edit-subtitle-size" class="rounded-md bg-gray-700 border-gray-600 text-white p-2">
                                <option value="text-2xl">大号</option>
                                <option value="text-xl">中号</option>
                                <option value="text-base">小号</option>
                            </select>
                            <select id="edit-subtitle-weight" class="rounded-md bg-gray-700 border-gray-600 text-white p-2">
                                <option value="font-normal">默认</option>
                                <option value="font-bold">粗体</option>
                                <option value="font-extrabold">极粗</option>
                            </select>
                            <input id="edit-subtitle-color-picker" type="color" class="h-10 w-full rounded-md bg-gray-700 border-gray-600 p-1 cursor-pointer" value="#9CA3AF">
                            <select id="edit-subtitle-spacing" class="rounded-md bg-gray-700 border-gray-600 text-white p-2">
                                <option value="tracking-normal">默认间距</option>
                                <option value="tracking-widest">最宽</option>
                                <option value="tracking-tight">更紧</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4 mt-6">
                    <button class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150" onclick="saveContent()">保存更改</button>
                    <button class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150" onclick="toggleEditMode(false)">取消</button>
                </div>
            </div>
        </div>

        <!-- Admin Toggle Button (始终可见，但功能受限) -->
        <button id="admin-toggle-btn" onclick="handleAdminToggle()" 
            class="fixed bottom-4 right-4 z-50 px-4 py-2 rounded-full text-white text-sm font-semibold shadow-xl transition-all duration-300 bg-gray-700 hover:bg-gray-600">
            Admin Mode (OFF)
        </button>


        <!-- 网格容器 (位于中心) -->
        <div id="grid-container" class="absolute inset-0 m-auto grid" 
            style="transform: translate(0, 0); transform-style: preserve-3d;">
            <!-- Grid items will be generated here by JavaScript -->
        </div>

        <!-- 视频模态框 (用于播放选中的项目) -->
        <div id="video-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex justify-center items-center hidden transition-opacity duration-300">
            <div class="relative w-full max-w-4xl h-auto aspect-video rounded-xl shadow-2xl overflow-hidden">
                <video id="video-player" class="w-full h-full object-cover" controls autoplay playsinline></video>
                <button id="close-modal" class="absolute top-4 right-4 text-white p-2 rounded-full bg-black/50 hover:bg-black/80 transition" aria-label="Close video">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Admin Item Edit Modal -->
        <div id="item-edit-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex justify-center items-center hidden transition-opacity duration-300">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h2 class="text-xl font-bold text-red-400 mb-4">编辑网格项目 <span id="item-edit-id" class="text-sm text-gray-400"></span></h2>
                
                <div class="space-y-4 text-white">
                    <div>
                        <label class="block text-sm font-medium text-gray-300">图像 URL (Image URL - 留空则显示颜色)</label>
                        <input id="edit-image-url" type="text" placeholder="https://example.com/image.jpg" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">视频 URL (Video URL - 播放时使用)</label>
                        <input id="edit-video-url" type="text" placeholder="https://example.com/video.mp4" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    </div>
                </div>

                <div class="flex space-x-4 mt-6">
                    <button class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150" onclick="saveItemChanges()">保存项目</button>
                    <button class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150" onclick="closeItemEditPanel()">取消</button>
                </div>
            </div>
        </div>
        
        <!-- Admin Auth Modal -->
        <div id="auth-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex justify-center items-center hidden transition-opacity duration-300">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h2 class="text-xl font-bold text-white mb-4">管理员登录</h2>
                
                <div class="space-y-4 text-white">
                    <div>
                        <label class="block text-sm font-medium text-gray-300">用户名</label>
                        <input id="auth-username" type="text" value="admin" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">密码</label>
                        <input id="auth-password" type="password" value="1234" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white p-2">
                    </div>
                    <p id="auth-error-message" class="text-red-400 text-sm hidden">用户名或密码错误。</p>
                </div>

                <div class="flex space-x-4 mt-6">
                    <button class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150" onclick="handleAdminLogin()">登录</button>
                    <button class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150" onclick="closeAuthModal()">取消</button>
                </div>
            </div>
        </div>

    </div>
</body>
</html>